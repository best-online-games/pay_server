<p align="center">
  <img src="./logo.svg" alt="logo" width="300"/>
</p>

## Go Clean Architecture Template

Шаблон для создания приложений в соответствии с принципами чистой архитектуры.

Ключевые моменты:

- Соответствие принципам чистой архитектуры
- Используются паттерны DDD
- Учтены лучшие практики написания кода на Go

Это шаблон, а не пример реального приложения. Задача шаблона быть максимально общим и показывать подходы, а не реализовывать конкретную бизнес-логику, которая будет отличаться для каждого реального приложения.

## Production docker-compose

1. Перейдите в директорию сервиса: `cd bog/pay_server`.
2. В каталоге `var/openvpn` уже подготовлены директории `server` и `clients`. Откройте `docker-compose.prod.yml`, при необходимости скорректируйте внешний порт `8080` и убедитесь, что эти папки будут использоваться как персистентное хранилище сертификатов.
3. Запустите сервис:
    ```bash
    docker compose -f docker-compose.prod.yml up -d --build
    ```

Команда собирает образ (используется `docker/prod/Dockerfile`) и маунтит директории:

- `./var/openvpn/server` → `/data/openvpn/server` (хранилище easy-rsa, client-common.txt и т.д.)
- `./var/openvpn/clients` → `/data/openvpn/clients` (готовые \*.ovpn файлы)

Остановить сервис можно стандартной командой:

```bash
docker compose -f docker-compose.prod.yml down
```

# Project layout

```
> tree -d
.
├── cmd
│   └── service
├── internal
│   ├── app
│   │   ├── adapters
│   │   │   ├── primary
│   │   │   │   └── http-adapter
│   │   │   └── secondary
│   │   │       └── openvpn
│   │   ├── application
│   │   │   └── usecases
│   │   ├── config
│   │   └── domain
│   │       └── openvpn
│   └── pkg
│       ├── http-server
│       └── middleware-helpers
└── var
    └── openvpn
        ├── clients
        └── server
```

## В разработке

### v0.0.3 (16.06.2025)

- Экземпляры БД теперь создаются вне репозиториев и передаются в них как аргументы (для pg)
- Заменён `sqlx` на `pgxpool`
- Заменён `kafka-go` на `franz-go`
- Заменён `go-clickhouse` на `clickhouse-go`
- Сущность `Book` заменена на несколько сущностей с более обобщёнными именами — `Entity*`
- `controllers` переименованы в `handlers` (так как "controllers" — термин из MVC)
- `provider` переименован в `gateway` (используется для HTTP-запросов к другим микросервисам)
- `libs` переименованы в `pkg` (`pkg` — более распространённое название)
- Обновлена конфигурация линтеров (1.64.8)
- `graceful` теперь оформлен как библиотека
- Различные исправления и улучшения
- Добавлен первоначальный логотип

### v0.0.2 (27.10.2024)

- Добавлена библиотека `graceful` для корректного завершения работы
- `http-adapter` готов
- Рефакторинг `main`: разделена инициализация и выполнение
- Конфиги теперь являются частью соответствующих пакетов
- Унифицированы имена пакетов (все в `snake_case`)
- Общий рефакторинг: переименование пакетов, переменных, функций и т.д.

### v0.0.1

- Начальная версия

---

### TODO

- [x] Удалить `config` из domain
- [x] Пересмотреть структуру `http-adapter`
- [x] Реализовать корректное завершение
- [ ] Подумать над веткой с внедрением зависимостей (DI)
- [x] Разделить слой адаптеров и слой инфраструктуры
- [x] Подумать о `fatal` в конструкторах адаптеров
- [x] Проверить, как передаётся `context` в адаптерах
- [ ] Подумать о замене (или добавлении) `Config.toml` на `yaml` или `hcl`
- [ ] Добавить менеджер транзакций?
- [x] Удалить `books`
- [x] Проверить адаптеры
- [x] Логотип
- [x] Перенести `infra` в `pkg`
- [ ] Привести проект к компилируемому состоянию

---

### Примечания

- **Opinionated**: в названиях пакетов используется `snake_case`
- **Opinionated**: структура и конструктор находятся в `init.go`, а методы — в `methods.go`

## Tests

Интеграционные тесты OpenVPN-менеджера (без моков) можно запустить командой:

```bash
go test ./internal/app/adapters/secondary/openvpn
```

## Security

- HTTP-ручки принимают запросы только c `Host` = `localhost`, `127.0.0.1`, `::1` или `pay.bog-best-online-games.ru`.
- Если браузер отправляет заголовок `Origin`, он тоже должен быть `https://pay.bog-best-online-games.ru`.
- Сертификаты и `.ovpn` конфигурации хранятся внутри проекта (`var/openvpn`) и пробрасываются в контейнер через `docker-compose.prod.yml`.

# FAQ

#### Why package names snake_case

#### Why pkg inside internal

#### It is a template of a project layout, not a example project
